<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Label Check | Dinas Kesehatan</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>

<h2>Cek Label Pangan Otomatis</h2>
<p>Upload foto label, sistem akan membaca isi teks dan menilai kelengkapannya.</p>

<input type="file" accept="image/*" id="upload" />

<pre id="output"></pre>
<div id="result"></div>

<script>
document.getElementById('upload').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;

    Tesseract.recognize(
        file,
        'eng',
        { logger: m => console.log(m) }
    ).then(({ data: { text } }) => {

        // Tampilkan full hasil OCR
        document.getElementById('output').innerText = text;

        // ================================
        // PROSES DETEKSI BARIS
        // ================================
        const lines = text
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.length > 2);

        let namaDagang = "Tidak ditemukan";
        let namaProduk = "Tidak ditemukan";

        // --- 1. Nama Dagang = baris paling atas ---
        if (lines.length > 0) {
            namaDagang = lines[0];
        }

        // --- 2. Nama Produk = baris paling panjang yang bukan angka atau kata kecil ---
        let kemungkinanProduk = lines.filter(l =>
            l.length > 5 &&
            !/komposisi|diproduksi|alamat|netto|p-?irt|exp|kedaluwarsa|bpom/i.test(l) &&
            !/^\d+$/.test(l)
        );

        if (kemungkinanProduk.length > 0) {
            // Ambil baris dengan karakter terbanyak (paling besar biasanya)
            kemungkinanProduk.sort((a, b) => b.length - a.length);
            namaProduk = kemungkinanProduk[0];
        }

        // ================================
        // DETEKSI KOMPONEN WAJIB
        // ================================
        const wajib = {
            "Nama Dagang": namaDagang,
            "Nama Produk": namaProduk,
            "Komposisi": /komposisi/i.test(text),
            "Netto": /netto|berat bersih/i.test(text),
            "PIRT": /p-irt|pirt|p\.irt/i.test(text),
            "Produsen": /diproduksi oleh|produsen|oleh/i.test(text),
            "Alamat Produsen": /alamat produsen|jl//i.test(text),
            "Kedaluwarsa": /exp|baik digunakan|baik dikomsumsi sebelum/i.test(text)
        };

        // ================================
        // TAMPILKAN HASIL
        // ================================
        let html = "<h3>Hasil Penilaian:</h3><ul>";

        html += `<li><b>Nama Dagang:</b> ${namaDagang}</li>`;
        html += `<li><b>Nama Produk:</b> ${namaProduk}</li>`;

        html += "<br>";

        Object.keys(wajib).forEach(key => {
            if (key === "Nama Dagang" || key === "Nama Produk") return;

            html += wajib[key]
                ? `<li>✔ ${key} - ADA</li>`
                : `<li>❌ ${key} - TIDAK ADA</li>`;
        });

        html += "</ul>";
        document.getElementById('result').innerHTML = html;

    });
});
</script>

</body>
</html>
