<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Label Check | Dinas Kesehatan</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>

<h2>Cek Label Pangan Otomatis</h2>
<p>Upload foto label, sistem akan membaca isi teks dan menilai kelengkapannya.</p>

<input type="file" accept="image/*" id="upload" />

<pre id="output"></pre>
<div id="result"></div>

<script>
document.getElementById('upload').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    Tesseract.recognize(file, 'eng', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {

            document.getElementById('output').innerText = text;

            // ─── Analisis teks menjadi baris ────────────────────────────
            const lines = text.split("\n")
                              .map(l => l.trim())
                              .filter(l => l.length > 0);

            // ─────────────────────────────────────────────────────────────
            //     DETEKSI NAMA DAGANG (BARIS PALING BANYAK HURUF KAPITAL)
            // ─────────────────────────────────────────────────────────────
            let namaDagang = "";
            let maxCaps = 0;

            lines.forEach(line => {
                const capsCount = (line.match(/[A-Z]/g) || []).length;
                if (capsCount > maxCaps && line.length < 40) { // biasanya singkat
                    maxCaps = capsCount;
                    namaDagang = line;
                }
            });

            // ─────────────────────────────────────────────────────────────
            //     DETEKSI NAMA PRODUK (BARIS YANG BUKAN ALAMAT/PRODUSEN)
            // ─────────────────────────────────────────────────────────────
            let namaProduk = "";
            const blacklist = /(diproduksi|oleh|alamat|komposisi|p-irt|pirt|netto|exp)/i;

            for (let line of lines) {
                if (!blacklist.test(line) && line.length > 3) {
                    namaProduk = line;
                    break;
                }
            }

            // ───────────── Daftar komponen label wajib ─────────────
            const wajib = {
                "Komposisi": /komposisi/i,
                "Netto": /netto|berat/i,
                "PIRT": /p-irt|pirt/i,
                "Produsen": /diproduksi|produsen|oleh/i,
                "Kedaluwarsa": /exp|baik digunakan/i
            };

            // ───────────── Hasil Penilaian ─────────────
            let html = "<h3>HASIL PENILAIAN:</h3><ul>";

            html += `<li>✔ Nama Dagang: <b>${namaDagang || "TIDAK TERDETEKSI"}</b></li>`;
            html += `<li>✔ Nama Produk: <b>${namaProduk || "TIDAK TERDETEKSI"}</b></li>`;

            Object.keys(wajib).forEach(key => {
                if (wajib[key].test(text)) {
                    html += `<li>✔ ${key} - ADA</li>`;
                } else {
                    html += `<li>❌ ${key} - TIDAK ADA</li>`;
                }
            });

            html += "</ul>";
            document.getElementById('result').innerHTML = html;
        });
});
</script>

</body>
</html>
